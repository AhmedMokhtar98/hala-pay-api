name: Deploy Node.js App

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Start SSH agent and add private key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: SSH & deploy on remote server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} << 'EOF'
            set -e

            # âœ… Ensure PM2 path exists in non-interactive SSH
            export PATH="$HOME/.npm-global/bin:$PATH"

            # Fix Git safe directory
            git config --global --add safe.directory /var/www/hala-pay-api || true

            cd /var/www/hala-pay-api

            echo "ðŸ”’ Backing up server .env (if exists)..."
            if [ -f .env ]; then
              cp .env /tmp/hala-pay-api.env.bak
              echo "âœ… .env backed up to /tmp/hala-pay-api.env.bak"
            else
              echo "â„¹ï¸ No .env found on server (will not restore)"
            fi

            # Pull latest code
            echo "â¬‡ï¸ Fetching latest code..."
            git fetch --all
            git reset --hard origin/master

            echo "ðŸ” Restoring server .env (if backup exists)..."
            if [ -f /tmp/hala-pay-api.env.bak ]; then
              mv /tmp/hala-pay-api.env.bak .env
              chmod 600 .env || true
              echo "âœ… .env restored"
            else
              echo "â„¹ï¸ No backup found, skipped restore"
            fi

            # Install dependencies
            echo "ðŸ“¦ Installing dependencies..."
            npm install --force

            # Restart Node.js app via PM2 (zero downtime)
            echo "â™»ï¸ Reloading PM2..."
            pm2 reload hala-pay-api || pm2 start index.js --name hala-pay-api

            echo "âœ… Deployment succeeded"
          EOF